# KQL Query & Explanation

This section outlines the Kusto Query Language (KQL) used to create the detection rule in Microsoft Sentinel, along with a detailed explanation of each clause and its purpose.

## KQL Query

```kql
DeviceProcessEvents
| where FileName =~ "powershell.exe"
| where ProcessCommandLine has "Invoke-WebRequest"
| where DeviceName =~ "noble-win10"
| where Timestamp > ago(1h)
| order by Timestamp desc
```
![](/4-Images/image3.png)

# Line-by-Line Breakdown

- `DeviceProcessEvents` This is the primary data source table from Microsoft Defender for Endpoint. It logs detailed information on all processes executed on an endpoint.

- `where FileName =~ "powershell.exe"`
Filters the dataset to include only events where the process involved is PowerShell. Case-insensitive matching ensures comprehensive coverage.

- `where ProcessCommandLine has "Invoke-WebRequest"`
Targets command lines that include the `Invoke-WebRequest` keyword — a strong indicator of potential malicious activity such as downloading payloads from the internet.

- `where DeviceName =~ "noble-win10"`
Limits detection to the designated test device. This helps reduce unnecessary noise during development and validation of the rule.

- `where Timestamp > ago(1h)`
Filters the results to only include events that occurred within the past hour. Ensures the rule catches recent activity and remains responsive.

- `order by Timestamp desc`
Sorts events with the most recent entries at the top for easier triage and faster analyst response.

---

# Query Rationale

This query is purpose-built to strike a balance between specificity and relevance. By:

- Focusing solely on PowerShell executions using `Invoke-WebRequest`,
- Narrowing down to a controlled test device,
- And applying a recent time window,

…the rule ensures timely, relevant alerts with high confidence. It allows SOC analysts to rapidly assess the context of the event and take informed action.

This rule plays a critical role in surfacing **initial access** and **payload delivery attempts**, offering an early line of defence in the incident response process.
