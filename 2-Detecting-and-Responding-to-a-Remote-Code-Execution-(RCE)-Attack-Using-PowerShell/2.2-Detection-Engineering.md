# Custom Detection Engineering

## 1. Creating a Custom Detection Rule Using KQL

The first step in this project was to create a custom detection rule in MDE, specifically targeting PowerShell commands that use `Invoke-WebRequest` and `Start-Process` to download and execute a file. The goal was to detect the RCE attack and trigger an automated response, such as isolating the VM and collecting an investigation package for analysis.

### KQL Query


```kql
let target = "Noble-Win10";
DeviceProcessEvents
| where DeviceName == target
| where InitiatingProcessCommandLine has_all ("Invoke-WebRequest", "Start-Process")
```
### Explanation

- **DeviceProcessEvents:** Tracks process activity on the device.
- **Invoke-WebRequest:** Typically used to download files from external sources, a common tactic for attackers.
- **Start-Process:** Executes the downloaded file, indicative of remote code execution.
- **Purpose:** This query is designed to detect instances where PowerShell uses these two commands to download and execute files, which is characteristic of an RCE attack.

---

### 2. Creating the Detection Rule in MDE

Once the KQL query was prepared, I used it to create a custom detection rule in Microsoft Defender for Endpoint.

#### Detection Rule Configuration

- **Rule Name:** Remote Code Execution - PowerShell 7-Zip Installer  
- **KQL Query:** (Same as above)  

**Actions:**

- **Isolate Device:** Automatically isolates the compromised VM to prevent further damage.  
- **Collect Investigation Package:** Gathers forensic data for analysis.  

After setting up the detection rule, I ensured that it was enabled to actively monitor for this type of attack.
